#!/usr/bin/env node

var commander = require('commander');
var lib = require('../lib.js');

commander
	.option('-p, --public <folder>', 'location of public folder relative to root', 'public')
	.option('-m, --mount <mount_path>', 'mount path for public folder', '/')
	.option('-l, --libs <folder>', 'comma seperated list of file paths or folders containing libraries relative to public folder', list, ['libs'])
	.option('-t, --tests <folder>', 'comma seperated list of file paths or folders containing tests relative to public folder', list, ['tests'])
	.option('-s, --scripts <folder>', 'comma seperated list of file paths or folders containing scripts to be tested relative to public folder', list, ['javascripts'])
	.option('-a, --advanced', 'flag indicating if advanced options must be used. When this flag is used ---opts is mandatory.')
	.option('-ao, --opts [public1:libs1:scripts1:tests1:mount1#public2:libs2:scripts2:tests2:mount2]', 'advanced options may be used in case the application has multiple public folders')
	.option('-b, --baseurl <url>', 'base url of web app', 'http://localhost:3000')
	.option('-r, --reports <folder>', 'location of reports folder relative to public folder', 'reports');

commander
	.command('report')
	.action(function () {
		var advanced = commander.advanced;
		var public = commander['public'];
		var mount = commander.mount;
		var libs = commander.libs;
		var scripts = commander.scripts;
		var tests = commander.tests;
		var reports = commander.reports;
		var baseurl = commander.baseurl;
		var opts = commander.opts;

		if (advanced && !opts) {
			throw 'Please specify --opts';
		}

		lib.generateReports({
			advanced: advanced,
			folders: !advanced ? [{
				"public": public,
				"libs": libs,
				"scripts": scripts,
				"tests": tests,
				"mount": mount
			}] : parseAdvancedOpts(opts),
			"reports": reports,
			"baseurl": baseurl
		});
	});


commander
	.command('test')
	.action(function () {
		var advanced = commander.advanced;
		var public = commander['public'];
		var mount = commander.mount;
		var libs = commander.libs;
		var scripts = commander.scripts;
		var tests = commander.tests;
		var reports = commander.reports;
		var baseurl = commander.baseurl;
		var opts = commander.opts;

		if (advanced && !opts) {
			throw 'Please specify --opts';
		}

		var folders = !advanced ? [{
			"public": public,
			"libs": libs,
			"scripts": scripts,
			"tests": tests,
			"mount": mount
		}] : parseAdvancedOpts(opts); 

		lib.generateTestFile({
			advanced: advanced,
			folders: folders
		});

		require('open')(baseurl + '/' + folders[folders.length - 1].mount + '/temp/index.html');
	});

commander
	.parse(process.argv);

function list(val) {
	return val.split(',');
}

function parseAdvancedOpts(opts){
	var result = [];

	var optArr = opts.split('#');
	optArr.forEach(function(opt){
		var argArr = opt.split(':');
		result.push({
			public: argArr[0],
			libs: argArr[1].split(','),
			scripts: argArr[2].split(','),
			tests: argArr[3].split(','),
			mount: argArr[4]
		});
	});

	return result;
}