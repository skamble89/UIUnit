#!/usr/bin/env node

var child_process = require('child_process');
var path = require('path');
var ejs = require('ejs');
var lib = require('../lib.js');

var public_folder = path.join(process.cwd(), '/public');
var scripts_folder = path.join(public_folder, '/javascripts');
var instrumented_scripts_folder = path.join(public_folder, '/instrumented_scripts');

var reports_folder = path.join(public_folder, '/reports');
var coverage_format = 'html';
var coverage_json_directory = './coverage';
var test_results_file = 'test_results.xml';
var test_html_page = './node_modules/uiunit/index.html';

lib.generateTestFile({
	instrument: true,
	folders: {
		libs: '',
		scripts: '',
		tests: ''
	}
});

//Run tests
child_process.execSync('node_modules\\.bin\\mocha-phantomjs -R xunit -f "' + path.join(reports_folder, test_results_file) + '" --hooks mocha-phantomjs-istanbul "' + test_html_page + '" --ignore-ssl-errors=true --ssl-protocol=any');

//Generate coverage report
child_process.execSync('node_modules\\.bin\\istanbul report --root "' + coverage_json_directory + '" --dir "' + path.join(reports_folder, 'coverage') + '" ' + coverage_format);